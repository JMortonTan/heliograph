<html>
	<head>
		<!-- Page Title -->
        <title>Heliograph</title>
		
		<!-- All three files required for Kandy  -->
		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
		<script src="https://kandy-portal.s3.amazonaws.com/public/javascript/fcs/1.0.0/fcs.js" ></script>
		<script src="https://kandy-portal.s3.amazonaws.com/public/javascript/kandy/1.1.2/kandy.js" ></script>

		<!-- Flare Object -->
		<script language = "JavaScript">
			Flare = function(commoner, description) {
			this.id = 0;
			this.commoner = commoner;
			this.description = description;
		}

		function flareSubmit() {
		var flare = new Flare($('#loggedInAs').val(),
										$('#loginBtn').val());

		var flareStr = JSON.stringify(flare);
		sendIm('user1@domain.com', flareStr);
		sendIm('user2@domain.com', flareStr);
		sendIm('user3@domain.com', flareStr);
		sendIm('user4@domain.com', flareStr);
		sendIm('user5@domain.com', flareStr);
		}

		/* when you receive a flare IM, make it an object like this
		var flare = flareStr = JSON.parse(flareStr);
		...then construct some HTML (a form to respond to a flare) and append it to a div tag
		*/

		// this is called when page is done loading to set up (initialize) the KandyAPI.Phone
		
		setup = function() {

        // initialize KandyAPI.Phone, passing a config JSON object that contains listeners (event callbacks)
        KandyAPI.Phone.setup({
            // respond to Kandy events...
            listeners: {
					loginsuccess: function () {
						changeUIState('LOGGED_IN');
						setInterval(getIms, 5000);
					},
					loginfailed: function () { alert("Login failed");}
				}
			});
		}

		login = function() {
			KandyAPI.Phone.login("DAK63ed5440255241d88666c634650bda4e", $("#logInId").val(), $('#passwd').val());
		}

		logout = function() {
			KandyAPI.Phone.logout(function () {
				changeUIState('LOGGED_OUT');
			});
		}

		sendIm = function() {
			var uuid = KandyAPI.Phone.sendIm(user4@heliograph2.com, $('#imMessageToSend').val(),
					function(result) {
						$('#messages').append('<div>' +
								'<span class="imUsername">' + $('#logInId').val() + '</span>' +
								'<span class="imMessage">' + $('#imMessageToSend').val() + '</span>' +
								'</div>');
						$('#imMessageToSend').val('');
						alert('Flare sent!');
					},
					function() {
						alert("IM send failed");
					}
			);
		};

    getIms = function() {
        KandyAPI.Phone.getIm(
                function(data) {
                    var i = 0;
                    for (i = 0; i < data.messages.length; ++i) {
                        var msg = data.messages[i];
                        if (msg.messageType == 'chat') {
                            var username = data.messages[i].sender.user_id;
                            var msg = data.messages[i].message.text

                            $('#messages').append('<div>' +
                                    '<span class="imUsername">' + username + '</span>' +
                                    '<span class="imMessage">' + msg + '</span>' +
                                    '</div>');
                        } else {
                            //alert("received " + msg.messageType + ": ");
                        }
                    }
                },
                function() {
                    alert("error receiving IMs");
                }
			)
		};

    changeUIState = function(state) {
        switch (state) {
            case 'LOGGED_OUT':
                $('#loggedInAs').val('');
                $("#loginForm").show();
                $("#loggedIn").hide();
                $('#messages').empty();
                $("#chat").hide();
                break;
            case 'LOGGED_IN':
                $('#loggedInAs').text($('#logInId').val());
                $("#loginForm").hide();
                $("#loggedIn").show();
                $("#chat").show();
                break;
        }
    }
</script>

		<style>
			#domainApiId{width:200px;margin-bottom:1px}
			#logInId{width:200px;margin:0 0 1px 64px;}
			#passwd{width:200px;margin-left: 41px;}
			#loginBtn{width:90px;height:23px;margin:5px 0 5px 110px;}
			.imUsername{display:inline-block; width:100px}
			#imMessageToSend{width:175px}
			#messages{border: solid black 1px}
			.imMessage{display:inline-block; width:275px}
			#logoutBtn{width:90px;height:23px;}
		</style>
	</head>

	<body id=main onload="setup()" style="width:500px;">
		<h2>Heliograph</h2>

		<div id="loggedIn" style="display:none">
		   Hello <span id="loggedInAs"></span>. &nbsp;&nbsp;&nbsp;&nbsp;
			<input id="logoutBtn" type="button" value="Log Out" onclick="logout()" />
		</div>
		
		<form id="loginForm">
			Username: <input id="logInId" type="text"/><br/>
			Password: <input id="passwd" type="password"/><br/>
			<input id="loginBtn" type="button" value="Log in" onclick="login();return false;"/>
		</form>
		
		<br/>
		<br/>
		
		<div id="chat" style="display:none">
			<form id="imForm" onsubmit="return false;">
				Message: <input id= "imMessageToSend" type="text"/>
				<input type="submit" onclick="sendIm();return false;" value="Send"/>  <br/>
			</form>
			<div id="messages" style="width:500px"></div>
		</div>
	</body>
</html>